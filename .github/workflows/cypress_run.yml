name: Cypress run E2E tests

on: [push]

jobs:
  cypress_run:
    runs-on: ubuntu-latest
    container: 
      image: cypress/browsers:node16.5.0-chrome94-ff93
      #options: --user 1001 # Cypress images are owned by user ID 1001 and by default Cypress run test with root user
    env:
      CYPRESS_CONFIG_FILE : ${{'cypress.json'}}
      CYPRESS_PROJECT_PATH : ${{'.'}}
      CYPRESS_RECORD_KEY : ${{secrets.CYPRESS_RECORD_KEY}}
      CYPRESS_REPORTER : ${{ 'spec' }}
      CYPRESS_BASE_URL : http://localhost:8080
      ADDITIONAL_OPTIONS : ${{''}}
      RECORD: ${{ false }}

    steps:
      - uses: actions/checkout@v2
      - name: Cache node modules
        uses: actions/cache@v2
        env:
          cache-name: cache-node-modules
        with:
          # A list of files, directories, and wildcard patterns to cache and restore
          path: |
            ~/.npm
            ~/.cache/Cypress
          # An explicit key for restoring and saving the cache
          key: ${{runner.os}}-build-${{env.cache-name}}-${{hashFiles('**/package-lock.json')}}
          # An ordered list of keys to use for restoring the cache if no cache hit occurred for key
          restore-keys: | # Optional
            ${{runner.os}}-build-${{env.cache-name}}-
      - name: Run Cypress tests
        run: |
          if [ ! -z ${{env.CYPRESS_RECORD_KEY}} ]; then
              export RECORD=${{ true }}
              echo "New RECORD value $RECORD"
          fi
      - name: Cypress run
        uses: cypress-io/github-action@v2
        with:
          project: ${{env.CYPRESS_PROJECT_PATH}}
          config-file: ${{env.CYPRESS_CONFIG_FILE }}
          record: ${{env.RECORD}}
          start: npm start 
          start-windows: npm run start:windows:server
          wait-on: ${{env.CYPRESS_BASE_URL}}
          #wait-on-timeout: 420
        env:
          # pass the Dashboard record key as an environment variable
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          # pass GitHub token to allow accurately detecting a build vs a re-run build
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Archive Cypress videos
        uses: actions/upload-artifact@v2
        if: always() 
        with:
          # Artifact name. Optional, default is artifact
          name: cypress-videos
          path: cypress/videos
          if-no-files-found: error
          retention-days: 15
      - name: Archive Cypress screenshots when job failed
        uses: actions/upload-artifact@v2
        if: failure()
        with:
          # Artifact name. Optional, default is artifact
          name: cypress-screenshots
          path: cypress/screenshots
          if-no-files-found: error
          retention-days: 15
